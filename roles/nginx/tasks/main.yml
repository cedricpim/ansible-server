---
- name: "install nginx and ssl-cert"
  apt:
    name: "{{ item }}"
    default_release: "{{ ansible_distribution_release }}-backports"
    state: "latest"
  with_items:
    - "nginx"
    - "ssl-cert"

- name: "create {{ nginx_user }} user"
  user:
    name: "{{ nginx_user }}"
    shell: "/bin/false"
    createhome: no
    state: "present"

- name: "create {{ nginx_content_directory }} directory"
  file:
    path: "{{ nginx_content_directory }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: "0755"
    state: "directory"

- name: "ensure {{ nginx_log_directory }} permissions are set"
  file:
    path: "{{ nginx_log_directory }}"
    owner: "{{ nginx_user }}"
    group: "{{ nginx_user }}"
    mode: "0755"
    state: "directory"

- name: "check if DHE parameter exists"
  stat:
    path: "{{ nginx_ssl_dhparam }}"
  register: dhe_parameter

- name: "generate a stronger DHE parameter"
  command: "openssl dhparam -out {{ nginx_ssl_dhparam }} 4096"
  when: dhe_parameter is defined and dhe_parameter.stat.islnk is not defined

- name: "copy main settings"
  template:
    src: "nginx.conf.j2"
    dest: "{{ nginx_config_directory }}/nginx.conf"
    mode: "0644"
  notify: "reload Nginx"

- name: "create Nginx directories for individual configurations"
  file:
    path: "{{ item }}"
    mode: "0755"
    state: "directory"
  with_items:
    - "{{ nginx_config_directory }}/conf.d"
    - "{{ nginx_config_directory }}/conf"

- name: "copy default server settings"
  template:
    src: "conf.d/default.conf.j2"
    dest: "{{ nginx_config_directory }}/conf.d/default.conf"
    mode: "0644"
  notify: "reload Nginx"

- name: "check for letsencrypt configuration"
  stat:
    path: "{{ nginx_config_directory }}/conf.d/letsencrypt.conf"
  register: st_letsencrypt

- name: "add placeholder certificates"
  lineinfile:
    path: "{{ nginx_config_directory }}/conf.d/default.conf"
    regexp: '{{ item }}'
    line: "  {{ item }};"
    insertafter: "server_name"
  with_items:
    - "ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key"
    - "ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem"
  notify: "reload Nginx"
  when: st_letsencrypt is defined and not st_letsencrypt.stat.exists

# FIX: https://bugs.launchpad.net/ubuntu/+source/nginx/+bug/1581864
- name: "override Nginx service"
  block:
    - file: path="{{ systemd_directory }}/nginx.service.d" owner="root" group="root" mode="0755" state="directory"
    - template: src="systemd/override.conf.j2" dest="{{ systemd_directory }}/nginx.service.d/override.conf" owner="root" group="root" mode="0644"
      notify: "restart Nginx"

- name: "enable/start nginx"
  systemd:
    name: "nginx"
    state: "started"
    enabled: yes
    daemon_reload: yes

- include_role:
    name: "monit"
    tasks_from: "configure"
  vars:
    conf: "nginx"

- include_role:
    name: "logrotate"
    tasks_from: "configure"
  vars:
    conf: "nginx"
