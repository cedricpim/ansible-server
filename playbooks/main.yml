---
- hosts: server
  become: yes

  vars_files:
    - "../vaulted_vars/system.yml"
    - "../group_vars/system.yml"

  pre_tasks:
    - name: "Update backports apt sources"
      apt_repository:
        repo: "deb http://ftp.debian.org/debian {{ ansible_distribution_release }}-backports main"
        state: "present"

    - name: "Update current packages"
      apt:
        upgrade: yes
        update_cache: yes
        force_apt_get: yes

  roles:
    - { role: "logrotate", tags: "logrotate" }
    - { role: "nginx", tags: "nginx" }
    - { role: "letsencrypt", tags: "letsencrypt" }
    - { role: "monit", tags: "monit" }
    - { role: "keeweb", tags: "keeweb" }
    - { role: "netdata", tags: "netdata" }
    - { role: "dav", tags: "dav" }
    - { role: "gallery", tags: "gallery" }
    - { role: "sync", tags: "sync" }
    - { role: "rkhunter", tags: "rkhunter" }
    - { role: "fail2ban", tags: "fail2ban" }
    - { role: "systemon", tags: "systemon" }
    - { role: "email", tags: "email" }

  post_tasks:
    - name: "Get list of users"
      command: "cut -d: -f1 /etc/passwd"
      changed_when: no
      register: users

    - name: "Check is newaliases command exists"
      command: "command -v newaliases"
      failed_when: no
      changed_when: no
      register: newaliases_exist

    - name: "Copy aliases"
      template:
        src: "aliases.j2"
        dest: "/etc/aliases"
        mode: "0644"
      register: template_aliases
      when:
        - users is defined
        - newaliases_exist.rc == 0

    - name: "Hash aliases"
      command: "newaliases"
      notify: "Reload Postfix"
      when:
        - template_aliases is defined
        - template_aliases.changed

    - name: "Restart Systemon"
      systemd:
        name: "systemon"
        state: "restarted"
      register: systemon_service
      failed_when:
        - systemon_service.failed
        - not "Could not find the requested service" in systemon_service.msg

    - name: "Remove dependencies that are no longer required"
      apt:
        autoremove: yes

    - name: "Remove useless packages from the cache"
      apt:
        autoclean: yes

  handlers:
    - name: "Reload Postfix"
      systemd:
        name: "postfix"
        state: "reloaded"
      register: postfix_service_reload
      failed_when:
        - postfix_service_reload.failed
        - not "Could not find the requested service" in postfix_service_reload.msg
