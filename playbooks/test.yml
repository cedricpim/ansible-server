---
- hosts: vagrant
  become: yes

  pre_tasks:
    - name: "Update backports apt sources"
      apt_repository:
        repo: "deb http://ftp.debian.org/debian {{ ansible_distribution_release }}-backports main"
        state: "present"

    - name: "Update current packages"
      apt:
        upgrade: yes
        update_cache: yes
        force_apt_get: yes

  roles:
    - { role: "general", tags: "general" }
    - { role: "logrotate", tags: "logrotate" }
    - { role: "nginx", tags: "nginx" }
    - { role: "monit", tags: "monit" }
    - { role: "keeweb", tags: "keeweb" }
    - { role: "netdata", tags: "netdata" }
    - { role: "dav", tags: "dav" }
    - { role: "gallery", tags: "gallery" }
    - { role: "sync", tags: "sync" }
    - { role: "rkhunter", tags: "rkhunter" }
    - { role: "fail2ban", tags: "fail2ban" }
    - { role: "systemon", tags: "systemon" }
    - { role: "email", tags: "email" }

  post_tasks:
    - name: "Get list of users"
      command: "cut -d: -f1 /etc/passwd"
      changed_when: no
      register: users

    - name: "Copy aliases"
      template:
        src: "aliases.j2"
        dest: "/etc/aliases"
        mode: "0644"
      register: template_aliases
      when: users is defined

    - name: "Hash aliases"
      command: "newaliases"
      notify:
        - "Start Postfix"
        - "Reload Postfix"
      when:
        - template_aliases is defined
        - template_aliases.changed

    - name: "Restart Systemon"
      systemd:
        name: "systemon"
        state: "restarted"
      register: systemon_service
      failed_when:
        - systemon_service.failed
        - not "Could not find the requested service" in systemon_service.msg
